{"version":3,"file":"transform.js","sourceRoot":"","sources":["../../../../../../src/transports/otlp/payload/transform/transform.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IKeyValue } from '@opentelemetry/otlp-transformer';\nimport {\n  SemanticAttributes,\n  SemanticResourceAttributes,\n  TelemetrySdkLanguageValues,\n} from '@opentelemetry/semantic-conventions';\n\nimport {\n  EventEvent,\n  ExceptionEvent,\n  LogEvent,\n  MeasurementEvent,\n  Meta,\n  TransportItem,\n  TransportItemType,\n  VERSION,\n} from '@grafana/faro-core';\n\nimport { internalLogger } from '../../otlpPayloadLogger';\nimport { isAttribute, toAttribute, toAttributeValue } from '../attribute';\n\nimport type { LogRecord, LogTransportItem, Resource, ScopeLog } from './types';\n\n/**\n * Seems currently to be missing in the semantic-conventions npm package.\n * See: https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/resource/semantic_conventions/README.md#todos\n *\n * Attributes are as defined by the Otel docs\n */\nconst SemanticBrowserAttributes = {\n  BROWSER_BRANDS: 'browser.brands',\n  BROWSER_PLATFORM: 'browser.platform',\n  BROWSER_MOBILE: 'browser.mobile',\n  BROWSER_USER_AGENT: 'browser.user_agent',\n  BROWSER_LANGUAGE: 'browser.language',\n} as const;\n\nexport function toResourceLog(transportItem: LogTransportItem) {\n  const resource = toResource(transportItem);\n\n  return {\n    resource,\n    scopeLogs: [toScopeLog(transportItem)],\n  };\n}\n\nfunction toResource(transportItem: LogTransportItem): Readonly<Resource> {\n  const { browser, sdk, app } = transportItem.meta;\n\n  return {\n    attributes: [\n      toAttribute(SemanticBrowserAttributes.BROWSER_MOBILE, browser?.mobile),\n      toAttribute(SemanticBrowserAttributes.BROWSER_USER_AGENT, browser?.userAgent),\n      toAttribute(SemanticBrowserAttributes.BROWSER_LANGUAGE, browser?.language),\n      toAttribute('browser.os', browser?.os),\n      // toAttribute(SemanticBrowserAttributes.BROWSER_BRANDS, browser?.brands),\n      toAttribute('browser.name', browser?.name),\n      toAttribute('browser.version', browser?.version),\n\n      toAttribute(SemanticResourceAttributes.TELEMETRY_SDK_NAME, sdk?.name),\n      toAttribute(SemanticResourceAttributes.TELEMETRY_SDK_VERSION, sdk?.version),\n      Boolean(sdk)\n        ? toAttribute(SemanticResourceAttributes.TELEMETRY_SDK_LANGUAGE, TelemetrySdkLanguageValues.WEBJS)\n        : undefined,\n\n      toAttribute(SemanticResourceAttributes.SERVICE_NAME, app?.name),\n      toAttribute(SemanticResourceAttributes.SERVICE_VERSION, app?.version),\n      toAttribute(SemanticResourceAttributes.DEPLOYMENT_ENVIRONMENT, app?.environment),\n    ].filter(isAttribute),\n  };\n}\n\nexport function toScopeLog(transportItem: LogTransportItem): ScopeLog {\n  return {\n    scope: {\n      name: '@grafana/faro-web-sdk',\n      version: VERSION,\n    },\n    logRecords: [toLogRecord(transportItem)],\n  };\n}\n\nfunction toLogRecord(transportItem: LogTransportItem): LogRecord {\n  const { type } = transportItem;\n\n  switch (type) {\n    case TransportItemType.LOG:\n      return toLogLogRecord(transportItem as TransportItem<LogEvent>);\n    case TransportItemType.EXCEPTION:\n      return toErrorLogRecord(transportItem as TransportItem<ExceptionEvent>);\n    case TransportItemType.EVENT:\n      return toEventLogRecord(transportItem as TransportItem<EventEvent>);\n    case TransportItemType.MEASUREMENT:\n      return toMeasurementLogRecord(transportItem as TransportItem<MeasurementEvent>);\n    default:\n      const error = `Unknown TransportItemType: ${type}`;\n      internalLogger.error(error);\n      throw new Error(error);\n  }\n}\n\nfunction toLogLogRecord(transportItem: TransportItem<LogEvent>): LogRecord {\n  const { meta, payload } = transportItem;\n  const timeUnixNano = toTimeUnixNano(payload.timestamp);\n  const body = toAttributeValue(payload.message) as { stringValue: string; key: string };\n\n  return {\n    timeUnixNano,\n    severityNumber: 10,\n    severityText: 'INFO2',\n    body,\n    attributes: getCommonLogAttributes(meta),\n    traceId: payload.trace?.trace_id,\n    spanId: payload.trace?.trace_id,\n  } as const;\n}\n\nfunction toEventLogRecord(transportItem: TransportItem<EventEvent>): LogRecord {\n  const { meta, payload } = transportItem;\n  const timeUnixNano = toTimeUnixNano(payload.timestamp);\n  const body = toAttributeValue(payload.name) as { stringValue: string; key: string };\n\n  return {\n    timeUnixNano,\n    body,\n    attributes: [\n      ...getCommonLogAttributes(meta),\n      toAttribute('event.name', payload.name), // No prefix because this is a semantic attribute. But event.name constant is currently missing in sematic-conventions npm package\n      toAttribute('event.domain', payload.domain), // No prefix because this is a semantic attribute. But event.domain constant is currently missing in sematic-conventions npm package\n      toAttribute('event.attributes', payload.attributes),\n    ].filter(isAttribute),\n    traceId: payload.trace?.trace_id,\n    spanId: payload.trace?.trace_id,\n  } as const;\n}\n\nfunction toErrorLogRecord(transportItem: TransportItem<ExceptionEvent>): LogRecord {\n  const { meta, payload } = transportItem;\n  const timeUnixNano = toTimeUnixNano(payload.timestamp);\n\n  return {\n    timeUnixNano,\n    attributes: [\n      ...getCommonLogAttributes(meta),\n      toAttribute(SemanticAttributes.EXCEPTION_TYPE, payload.type),\n      toAttribute(SemanticAttributes.EXCEPTION_MESSAGE, payload.value),\n      // toAttribute(SemanticAttributes.EXCEPTION_STACKTRACE, undefined),\n      toAttribute('faro.error.stacktrace', payload.stacktrace),\n    ].filter(isAttribute),\n    traceId: payload.trace?.trace_id,\n    spanId: payload.trace?.trace_id,\n  } as const;\n}\n\nfunction toMeasurementLogRecord(transportItem: TransportItem<MeasurementEvent>): LogRecord {\n  const { meta, payload } = transportItem;\n  const timeUnixNano = toTimeUnixNano(payload.timestamp);\n  const [measurementName, measurementValue] = Object.entries(payload.values).flat();\n\n  return {\n    timeUnixNano,\n    attributes: [\n      ...getCommonLogAttributes(meta),\n      toAttribute('measurement.type', payload.type),\n      toAttribute('measurement.name', measurementName),\n      toAttribute('measurement.value', measurementValue),\n    ].filter(isAttribute),\n    traceId: payload.trace?.trace_id,\n    spanId: payload.trace?.trace_id,\n  } as const;\n}\n\nfunction getCommonLogAttributes(meta: Meta): IKeyValue[] {\n  const { view, page, session, user } = meta;\n\n  return [\n    toAttribute('view.name', view?.name),\n    toAttribute(SemanticAttributes.HTTP_URL, page?.url),\n    toAttribute('page.id', page?.id),\n    toAttribute('page.attributes', page?.attributes),\n    toAttribute('session.id', session?.id),\n    toAttribute('session.attributes', session?.attributes),\n    toAttribute(SemanticAttributes.ENDUSER_ID, user?.id),\n    toAttribute('enduser.name', user?.username),\n    toAttribute('enduser.email', user?.email),\n    toAttribute('enduser.attributes', user?.attributes),\n  ].filter(isAttribute);\n}\n\nfunction toTimeUnixNano(timestamp: string): number {\n  return Date.parse(timestamp) * 1e6;\n}\n"]}