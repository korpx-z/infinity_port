{"version":3,"file":"fieldOverrides.js","sources":["../../../src/field/fieldOverrides.ts"],"sourcesContent":["import { isNumber, set, unset, get, cloneDeep } from 'lodash';\nimport { useMemo, useRef } from 'react';\nimport usePrevious from 'react-use/lib/usePrevious';\n\nimport { VariableFormatID } from '@grafana/schema';\n\nimport { compareArrayValues, compareDataFrameStructures, guessFieldTypeForField } from '../dataframe';\nimport { PanelPlugin } from '../panel/PanelPlugin';\nimport { GrafanaTheme2 } from '../themes';\nimport { asHexString } from '../themes/colorManipulator';\nimport { fieldMatchers, reduceField, ReducerID } from '../transformations';\nimport {\n  ApplyFieldOverrideOptions,\n  DataContextScopedVar,\n  DataFrame,\n  DataLink,\n  DecimalCount,\n  DisplayProcessor,\n  DisplayValue,\n  DynamicConfigValue,\n  Field,\n  FieldColorModeId,\n  FieldConfig,\n  FieldConfigPropertyItem,\n  FieldConfigSource,\n  FieldOverrideContext,\n  FieldType,\n  InterpolateFunction,\n  LinkModel,\n  NumericRange,\n  PanelData,\n  ScopedVars,\n  TimeZone,\n  ValueLinkConfig,\n} from '../types';\nimport { FieldMatcher } from '../types/transformations';\nimport { locationUtil } from '../utils';\nimport { mapInternalLinkToExplore } from '../utils/dataLinks';\n\nimport { FieldConfigOptionsRegistry } from './FieldConfigOptionsRegistry';\nimport { getDisplayProcessor, getRawDisplayProcessor } from './displayProcessor';\nimport { getFrameDisplayName } from './fieldState';\nimport { getFieldDisplayValuesProxy } from './getFieldDisplayValuesProxy';\nimport { standardFieldConfigEditorRegistry } from './standardFieldConfigEditorRegistry';\nimport { getTemplateProxyForField } from './templateProxies';\n\ninterface OverrideProps {\n  match: FieldMatcher;\n  properties: DynamicConfigValue[];\n}\n\nexport function findNumericFieldMinMax(data: DataFrame[]): NumericRange {\n  let min: number | null = null;\n  let max: number | null = null;\n\n  const reducers = [ReducerID.min, ReducerID.max];\n\n  for (const frame of data) {\n    for (const field of frame.fields) {\n      if (field.type === FieldType.number) {\n        const stats = reduceField({ field, reducers });\n        const statsMin = stats[ReducerID.min];\n        const statsMax = stats[ReducerID.max];\n\n        if (min === null || statsMin < min) {\n          min = statsMin;\n        }\n\n        if (max === null || statsMax > max) {\n          max = statsMax;\n        }\n      }\n    }\n  }\n\n  return { min, max, delta: (max ?? 0) - (min ?? 0) };\n}\n\n/**\n * Return a copy of the DataFrame with all rules applied\n */\nexport function applyFieldOverrides(options: ApplyFieldOverrideOptions): DataFrame[] {\n  if (!options.data) {\n    return [];\n  }\n\n  const source = options.fieldConfig;\n  if (!source) {\n    return options.data;\n  }\n\n  const fieldConfigRegistry = options.fieldConfigRegistry ?? standardFieldConfigEditorRegistry;\n\n  let seriesIndex = 0;\n  let globalRange: NumericRange | undefined = undefined;\n\n  // Prepare the Matchers\n  const override: OverrideProps[] = [];\n  if (source.overrides) {\n    for (const rule of source.overrides) {\n      const info = fieldMatchers.get(rule.matcher.id);\n      if (info) {\n        override.push({\n          match: info.get(rule.matcher.options),\n          properties: rule.properties,\n        });\n      }\n    }\n  }\n\n  return options.data.map((originalFrame, index) => {\n    // Need to define this new frame here as it's passed to the getLinkSupplier function inside the fields loop\n    const newFrame: DataFrame = { ...originalFrame };\n    // Copy fields\n    newFrame.fields = newFrame.fields.map((field) => {\n      return {\n        ...field,\n        config: cloneDeep(field.config),\n        state: {\n          ...field.state,\n        },\n      };\n    });\n\n    const scopedVars: ScopedVars = {\n      __series: { text: 'Series', value: { name: getFrameDisplayName(newFrame, index) } }, // might be missing\n    };\n\n    for (const field of newFrame.fields) {\n      const config = field.config;\n\n      field.state!.scopedVars = {\n        ...scopedVars,\n        __field: {\n          text: 'Field',\n          value: getTemplateProxyForField(field, newFrame, options.data),\n        },\n      };\n\n      const context = {\n        field: field,\n        data: options.data!,\n        dataFrameIndex: index,\n        replaceVariables: options.replaceVariables,\n        fieldConfigRegistry: fieldConfigRegistry,\n      };\n\n      // Anything in the field config that's not set by the datasource\n      // will be filled in by panel's field configuration\n      setFieldConfigDefaults(config, source.defaults, context);\n\n      // Find any matching rules and then override\n      for (const rule of override) {\n        if (rule.match(field, newFrame, options.data!)) {\n          for (const prop of rule.properties) {\n            // config.scopedVars is set already here\n            setDynamicConfigValue(config, prop, context);\n          }\n        }\n      }\n\n      // Try harder to set a real value that is not 'other'\n      let type = field.type;\n      if (!type || type === FieldType.other) {\n        const t = guessFieldTypeForField(field);\n        if (t) {\n          type = t;\n        }\n      }\n\n      // Set the Min/Max value automatically\n      let range: NumericRange | undefined = undefined;\n      if (field.type === FieldType.number) {\n        if (!globalRange && (!isNumber(config.min) || !isNumber(config.max))) {\n          globalRange = findNumericFieldMinMax(options.data!);\n        }\n        const min = config.min ?? globalRange!.min;\n        const max = config.max ?? globalRange!.max;\n        range = { min, max, delta: max! - min! };\n      }\n\n      field.state!.seriesIndex = seriesIndex;\n      field.state!.range = range;\n      field.type = type;\n\n      // Some color modes needs series index to assign field color so we count\n      // up series index here but ignore time fields\n      if (field.type !== FieldType.time) {\n        seriesIndex++;\n      }\n\n      // and set the display processor using it\n      field.display = getDisplayProcessor({\n        field: field,\n        theme: options.theme,\n        timeZone: options.timeZone,\n      });\n\n      // Wrap the display with a cache to avoid double calls\n      if (field.config.unit !== 'dateTimeFromNow') {\n        field.display = cachingDisplayProcessor(field.display, 2500);\n      }\n\n      // Attach data links supplier\n      field.getLinks = getLinksSupplier(\n        newFrame,\n        field,\n        field.state!.scopedVars,\n        context.replaceVariables,\n        options.timeZone\n      );\n    }\n\n    return newFrame;\n  });\n}\n\n// this is a significant optimization for streaming, where we currently re-process all values in the buffer on ech update\n// via field.display(value). this can potentially be removed once we...\n// 1. process data packets incrementally and/if cache the results in the streaming datafame (maybe by buffer index)\n// 2. have the ability to selectively get display color or text (but not always both, which are each quite expensive)\n// 3. sufficently optimize text formatting and threshold color determinitation\nfunction cachingDisplayProcessor(disp: DisplayProcessor, maxCacheSize = 2500): DisplayProcessor {\n  type dispCache = Map<any, DisplayValue>;\n  // decimals -> cache mapping, -1 is unspecified decimals\n  const caches = new Map<number, dispCache>();\n\n  // pre-init caches for up to 15 decimals\n  for (let i = -1; i <= 15; i++) {\n    caches.set(i, new Map());\n  }\n\n  return (value: any, decimals?: DecimalCount) => {\n    let cache = caches.get(decimals ?? -1)!;\n\n    let v = cache.get(value);\n\n    if (!v) {\n      // Don't grow too big\n      if (cache.size === maxCacheSize) {\n        cache.clear();\n      }\n\n      v = disp(value, decimals);\n\n      // convert to hex6 or hex8 so downstream we can cheaply test for alpha (and set new alpha)\n      // via a simple length check (in colorManipulator) rather using slow parsing via tinycolor\n      if (v.color) {\n        v.color = asHexString(v.color);\n      }\n\n      cache.set(value, v);\n    }\n\n    return v;\n  };\n}\n\nexport interface FieldOverrideEnv extends FieldOverrideContext {\n  fieldConfigRegistry: FieldConfigOptionsRegistry;\n}\n\nexport function setDynamicConfigValue(config: FieldConfig, value: DynamicConfigValue, context: FieldOverrideEnv) {\n  const reg = context.fieldConfigRegistry;\n  const item = reg.getIfExists(value.id);\n\n  if (!item) {\n    return;\n  }\n\n  const val = item.process(value.value, context, item.settings);\n\n  const remove = val === undefined || val === null;\n\n  if (remove) {\n    if (item.isCustom && config.custom) {\n      unset(config.custom, item.path);\n    } else {\n      unset(config, item.path);\n    }\n  } else {\n    if (item.isCustom) {\n      if (!config.custom) {\n        config.custom = {};\n      }\n      set(config.custom, item.path, val);\n    } else {\n      set(config, item.path, val);\n    }\n  }\n}\n\n// config -> from DS\n// defaults -> from Panel config\nexport function setFieldConfigDefaults(config: FieldConfig, defaults: FieldConfig, context: FieldOverrideEnv) {\n  // For cases where we have links on the datasource config and the panel config, we need to merge them\n  if (config.links && defaults.links) {\n    // Combine the data source links and the panel default config links\n    config.links = [...config.links, ...defaults.links];\n  }\n  for (const fieldConfigProperty of context.fieldConfigRegistry.list()) {\n    if (fieldConfigProperty.isCustom && !config.custom) {\n      config.custom = {};\n    }\n    processFieldConfigValue(\n      fieldConfigProperty.isCustom ? config.custom : config,\n      fieldConfigProperty.isCustom ? defaults.custom : defaults,\n      fieldConfigProperty,\n      context\n    );\n  }\n\n  validateFieldConfig(config);\n}\n\nfunction processFieldConfigValue(\n  destination: Record<string, any>, // it's mutable\n  source: Record<string, any>,\n  fieldConfigProperty: FieldConfigPropertyItem,\n  context: FieldOverrideEnv\n) {\n  const currentConfig = get(destination, fieldConfigProperty.path);\n  if (currentConfig === null || currentConfig === undefined) {\n    const item = context.fieldConfigRegistry.getIfExists(fieldConfigProperty.id);\n    if (!item) {\n      return;\n    }\n\n    if (item && item.shouldApply(context.field!)) {\n      const val = item.process(get(source, item.path), context, item.settings);\n      if (val !== undefined && val !== null) {\n        set(destination, item.path, val);\n      }\n    }\n  }\n}\n\n/**\n * This checks that all options on FieldConfig make sense.  It mutates any value that needs\n * fixed.  In particular this makes sure that the first threshold value is -Infinity (not valid in JSON)\n */\nexport function validateFieldConfig(config: FieldConfig) {\n  const { thresholds } = config;\n\n  if (!config.color) {\n    if (thresholds) {\n      config.color = {\n        mode: FieldColorModeId.Thresholds,\n      };\n    }\n    // No Color settings\n  } else if (!config.color.mode) {\n    // Without a mode, skip color altogether\n    delete config.color;\n  }\n\n  // Verify that max > min (swap if necessary)\n  if (config.hasOwnProperty('min') && config.hasOwnProperty('max') && config.min! > config.max!) {\n    const tmp = config.max;\n    config.max = config.min;\n    config.min = tmp;\n  }\n}\n\nexport const getLinksSupplier =\n  (\n    frame: DataFrame,\n    field: Field,\n    fieldScopedVars: ScopedVars,\n    replaceVariables: InterpolateFunction,\n    timeZone?: TimeZone\n  ) =>\n  (config: ValueLinkConfig): Array<LinkModel<Field>> => {\n    if (!field.config.links || field.config.links.length === 0) {\n      return [];\n    }\n\n    return field.config.links.map((link: DataLink) => {\n      let dataFrameVars = {};\n      let dataContext: DataContextScopedVar = { value: { frame, field } };\n\n      // We are not displaying reduction result\n      if (config.valueRowIndex !== undefined && !isNaN(config.valueRowIndex)) {\n        dataContext.value.rowIndex = config.valueRowIndex;\n\n        const fieldsProxy = getFieldDisplayValuesProxy({\n          frame,\n          rowIndex: config.valueRowIndex,\n          timeZone: timeZone,\n        });\n\n        dataFrameVars = {\n          __data: {\n            value: {\n              name: frame.name,\n              refId: frame.refId,\n              fields: fieldsProxy,\n            },\n            text: 'Data',\n          },\n        };\n      } else {\n        dataContext.value.calculatedValue = config.calculatedValue;\n      }\n\n      const variables: ScopedVars = {\n        ...fieldScopedVars,\n        ...dataFrameVars,\n        __dataContext: dataContext,\n      };\n\n      if (link.onClick) {\n        return {\n          href: link.url,\n          title: replaceVariables(link.title || '', variables),\n          target: link.targetBlank ? '_blank' : undefined,\n          onClick: (evt, origin) => {\n            link.onClick!({\n              origin: origin ?? field,\n              e: evt,\n              replaceVariables: (v) => replaceVariables(v, variables),\n            });\n          },\n          origin: field,\n        };\n      }\n\n      if (link.internal) {\n        // For internal links at the moment only destination is Explore.\n        return mapInternalLinkToExplore({\n          link,\n          internalLink: link.internal,\n          scopedVars: variables,\n          field,\n          range: link.internal.range ?? ({} as any),\n          replaceVariables,\n        });\n      }\n      let href = link.onBuildUrl\n        ? link.onBuildUrl({\n            origin: field,\n            replaceVariables,\n          })\n        : link.url;\n\n      if (href) {\n        href = locationUtil.assureBaseUrl(href.replace(/\\n/g, ''));\n        href = replaceVariables(href, variables, VariableFormatID.UriEncode);\n        href = locationUtil.processUrl(href);\n      }\n\n      const info: LinkModel<Field> = {\n        href,\n        title: replaceVariables(link.title || '', variables),\n        target: link.targetBlank ? '_blank' : undefined,\n        origin: field,\n      };\n      return info;\n    });\n  };\n\n/**\n * Return a copy of the DataFrame with raw data\n */\nexport function applyRawFieldOverrides(data: DataFrame[]): DataFrame[] {\n  if (!data || data.length === 0) {\n    return [];\n  }\n\n  const newData = [...data];\n  const processor = getRawDisplayProcessor();\n\n  for (let frameIndex = 0; frameIndex < newData.length; frameIndex++) {\n    const newFrame = { ...newData[frameIndex] };\n    const newFields = [...newFrame.fields];\n\n    for (let fieldIndex = 0; fieldIndex < newFields.length; fieldIndex++) {\n      newFields[fieldIndex] = {\n        ...newFields[fieldIndex],\n        display: processor,\n      };\n    }\n\n    newData[frameIndex] = {\n      ...newFrame,\n      fields: newFields,\n    };\n  }\n\n  return newData;\n}\n\n/**\n * @internal\n */\nexport function useFieldOverrides(\n  plugin: PanelPlugin | undefined,\n  fieldConfig: FieldConfigSource | undefined,\n  data: PanelData | undefined,\n  timeZone: string,\n  theme: GrafanaTheme2,\n  replace: InterpolateFunction\n): PanelData | undefined {\n  const fieldConfigRegistry = plugin?.fieldConfigRegistry;\n  const structureRev = useRef(0);\n  const prevSeries = usePrevious(data?.series);\n\n  return useMemo(() => {\n    if (!fieldConfigRegistry || !fieldConfig || !data) {\n      return;\n    }\n\n    const series = data?.series;\n\n    if (\n      data.structureRev == null &&\n      series &&\n      prevSeries &&\n      !compareArrayValues(series, prevSeries, compareDataFrameStructures)\n    ) {\n      structureRev.current++;\n    }\n\n    return {\n      structureRev: structureRev.current,\n      ...data,\n      series: applyFieldOverrides({\n        data: series,\n        fieldConfig,\n        fieldConfigRegistry,\n        replaceVariables: replace,\n        theme,\n        timeZone,\n      }),\n    };\n  }, [fieldConfigRegistry, fieldConfig, data, prevSeries, timeZone, theme, replace]);\n}\n"],"names":["_a"],"mappings":"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"}